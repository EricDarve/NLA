{"version":3,"file":"worker.js","sources":["../src/transfer.js","../src/worker.js"],"sourcesContent":["/**\n * The helper class for transferring data from the worker to the main thread.\n *\n * @param {Object} message The object to deliver to the main thread.\n * @param {Object[]} transfer An array of transferable Objects to transfer ownership of.\n */\nfunction Transfer(message, transfer) {\n  this.message = message;\n  this.transfer = transfer;\n}\n\nmodule.exports = Transfer;\n","/**\n * worker must be started as a child process or a web worker.\n * It listens for RPC messages from the parent process.\n */\nvar Transfer = require('./transfer');\n\n/**\n * Special message sent by parent which causes the worker to terminate itself.\n * Not a \"message object\"; this string is the entire message.\n */\nvar TERMINATE_METHOD_ID = '__workerpool-terminate__';\n\n// var nodeOSPlatform = require('./environment').nodeOSPlatform;\n\n// create a worker API for sending and receiving messages which works both on\n// node.js and in the browser\nvar worker = {\n  exit: function() {}\n};\nif (typeof self !== 'undefined' && typeof postMessage === 'function' && typeof addEventListener === 'function') {\n  // worker in the browser\n  worker.on = function (event, callback) {\n    addEventListener(event, function (message) {\n      callback(message.data);\n    })\n  };\n  worker.send = function (message, transfer) {\n     transfer ? postMessage(message, transfer) : postMessage (message);\n  };\n}\nelse if (typeof process !== 'undefined') {\n  // node.js\n\n  var WorkerThreads;\n  try {\n    WorkerThreads = require('worker_threads');\n  } catch(error) {\n    if (typeof error === 'object' && error !== null && error.code === 'MODULE_NOT_FOUND') {\n      // no worker_threads, fallback to sub-process based workers\n    } else {\n      throw error;\n    }\n  }\n\n  if (WorkerThreads &&\n    /* if there is a parentPort, we are in a WorkerThread */\n    WorkerThreads.parentPort !== null) {\n    var parentPort  = WorkerThreads.parentPort;\n    worker.send = parentPort.postMessage.bind(parentPort);\n    worker.on = parentPort.on.bind(parentPort);\n    worker.exit = process.exit.bind(process);\n  } else {\n    worker.on = process.on.bind(process);\n    // ignore transfer argument since it is not supported by process\n    worker.send = function (message) {\n      process.send(message);\n    };\n    // register disconnect handler only for subprocess worker to exit when parent is killed unexpectedly\n    worker.on('disconnect', function () {\n      process.exit(1);\n    });\n    worker.exit = process.exit.bind(process);\n  }\n}\nelse {\n  throw new Error('Script must be executed as a worker');\n}\n\nfunction convertError(error) {\n  return Object.getOwnPropertyNames(error).reduce(function(product, name) {\n    return Object.defineProperty(product, name, {\n\tvalue: error[name],\n\tenumerable: true\n    });\n  }, {});\n}\n\n/**\n * Test whether a value is a Promise via duck typing.\n * @param {*} value\n * @returns {boolean} Returns true when given value is an object\n *                    having functions `then` and `catch`.\n */\nfunction isPromise(value) {\n  return value && (typeof value.then === 'function') && (typeof value.catch === 'function');\n}\n\n// functions available externally\nworker.methods = {};\n\n/**\n * Execute a function with provided arguments\n * @param {String} fn     Stringified function\n * @param {Array} [args]  Function arguments\n * @returns {*}\n */\nworker.methods.run = function run(fn, args) {\n  var f = new Function('return (' + fn + ').apply(null, arguments);');\n  return f.apply(f, args);\n};\n\n/**\n * Get a list with methods available on this worker\n * @return {String[]} methods\n */\nworker.methods.methods = function methods() {\n  return Object.keys(worker.methods);\n};\n\n/**\n * Custom handler for when the worker is terminated.\n */\nworker.terminationHandler = undefined;\n\n/**\n * Cleanup and exit the worker.\n * @param {Number} code \n * @returns \n */\nworker.cleanupAndExit = function(code) {\n  var _exit = function() {\n    worker.exit(code);\n  }\n\n  if(!worker.terminationHandler) {\n    return _exit();\n  }\n\n  var result = worker.terminationHandler(code);\n  if (isPromise(result)) {\n    result.then(_exit, _exit);\n  } else {\n    _exit();\n  }\n}\n\nvar currentRequestId = null;\n\nworker.on('message', function (request) {\n  if (request === TERMINATE_METHOD_ID) {\n    return worker.cleanupAndExit(0);\n  }\n  try {\n    var method = worker.methods[request.method];\n\n    if (method) {\n      currentRequestId = request.id;\n      \n      // execute the function\n      var result = method.apply(method, request.params);\n\n      if (isPromise(result)) {\n        // promise returned, resolve this and then return\n        result\n            .then(function (result) {\n              if (result instanceof Transfer) {\n                worker.send({\n                  id: request.id,\n                  result: result.message,\n                  error: null\n                }, result.transfer);\n              } else {\n                worker.send({\n                  id: request.id,\n                  result: result,\n                  error: null\n                });\n              }\n              currentRequestId = null;\n            })\n            .catch(function (err) {\n              worker.send({\n                id: request.id,\n                result: null,\n                error: convertError(err)\n              });\n              currentRequestId = null;\n            });\n      }\n      else {\n        // immediate result\n        if (result instanceof Transfer) {\n          worker.send({\n            id: request.id,\n            result: result.message,\n            error: null\n          }, result.transfer);\n        } else {\n          worker.send({\n            id: request.id,\n            result: result,\n            error: null\n          });\n        }\n\n        currentRequestId = null;\n      }\n    }\n    else {\n      throw new Error('Unknown method \"' + request.method + '\"');\n    }\n  }\n  catch (err) {\n    worker.send({\n      id: request.id,\n      result: null,\n      error: convertError(err)\n    });\n  }\n});\n\n/**\n * Register methods to the worker\n * @param {Object} [methods]\n * @param {import('./types.js').WorkerRegisterOptions} [options]\n */\nworker.register = function (methods, options) {\n\n  if (methods) {\n    for (var name in methods) {\n      if (methods.hasOwnProperty(name)) {\n        worker.methods[name] = methods[name];\n      }\n    }\n  }\n\n  if (options) {\n    worker.terminationHandler = options.onTerminate;\n  }\n\n  worker.send('ready');\n};\n\nworker.emit = function (payload) {\n  if (currentRequestId) {\n    if (payload instanceof Transfer) {\n      worker.send({\n        id: currentRequestId,\n        isEvent: true,\n        payload: payload.message\n      }, payload.transfer);\n      return;\n    }\n\n    worker.send({\n      id: currentRequestId,\n      isEvent: true,\n      payload\n    });\n  }\n};\n\nif (typeof exports !== 'undefined') {\n  exports.add = worker.register;\n  exports.emit = worker.emit;\n}\n"],"names":["Transfer","message","transfer","require$$0","TERMINATE_METHOD_ID","worker","exit","self","postMessage","addEventListener","on","event","callback","data","send","process","WorkerThreads","require","error","_typeof","code","parentPort","bind","Error","convertError","Object","getOwnPropertyNames","reduce","product","name","defineProperty","value","enumerable","isPromise","then","catch","methods","run","fn","args","f","Function","apply","keys","terminationHandler","undefined","cleanupAndExit","_exit","result","currentRequestId","request","method","id","params","err","register","options","hasOwnProperty","onTerminate","emit","payload","isEvent","exports","add"],"mappings":"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"}